generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/late_content_poster/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                 String              @id @default(cuid())
  name               String?
  email              String              @unique
  emailVerified      DateTime?
  image              String?
  firstName          String?
  lastName           String?
  password           String?
  role               String              @default("USER")
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  selectedCompanyId  String?             // Currently selected company
  accounts           Account[]
  contentTemplates   ContentTemplate[]
  graphics           GeneratedGraphic[]
  platformSettings   PlatformSetting[]
  posts              Post[]
  analytics          PostAnalytics[]
  schedules          PostSchedule[]
  profiles           Profile[]
  sessions           Session[]
  templates          Template[]
  workspaceBrandings WorkspaceBranding[]
  teams              Team[]
  postSeries         PostSeries[]
  companyMemberships CompanyMember[]
  ownedCompanies     Company[]           @relation("CompanyOwner")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Company {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  ownerId            String
  logoUrl            String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  owner              User                @relation("CompanyOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members            CompanyMember[]
  contentTemplates   ContentTemplate[]
  profiles           Profile[]
  platformSettings   PlatformSetting[]
  posts              Post[]
  postSchedules      PostSchedule[]
  postAnalytics      PostAnalytics[]
  savedPrompts       SavedPrompt[]
  promptFolders      PromptFolder[]
  templates          Template[]
  generatedGraphics  GeneratedGraphic[]
  workspaceBrandings WorkspaceBranding[]
  teams              Team[]
  postSeries         PostSeries[]
  driveMappings      GoogleDriveFolderMapping[]

  @@unique([ownerId, name])
  @@index([ownerId])
}

model CompanyMember {
  id        String   @id @default(cuid())
  companyId String?
  userId    String
  role      String   @default("MEMBER") // OWNER, ADMIN, MEMBER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([userId])
}

model ContentTemplate {
  id          String   @id @default(cuid())
  userId      String
  companyId   String?
  title       String
  content     String
  caption     String?
  hashtags    String?
  contentType String
  topic       String?
  platforms   String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  posts       Post[]

  @@index([companyId])
  @@index([userId, companyId])
}

model Profile {
  id               String            @id @default(cuid())
  userId           String
  companyId        String?
  name             String
  description      String?
  isDefault        Boolean           @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  lateProfileId    String?
  platformSettings PlatformSetting[]
  postSeries       PostSeries[]
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  company          Company?           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@index([companyId])
  @@index([userId, companyId])
}

model PlatformSetting {
  id           String   @id @default(cuid())
  userId       String
  companyId    String?
  platform     String
  platformId   String?
  isConnected  Boolean  @default(false)
  isActive     Boolean  @default(true)
  settings     Json?
  accessToken  String?
  refreshToken String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  profileId    String
  profile      Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company      Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([profileId, platform])
  @@index([companyId])
  @@index([userId, companyId])
}

model Post {
  id                String           @id @default(cuid())
  userId            String
  companyId         String?
  contentTemplateId String?
  seriesId          String?
  content           String
  caption           String?
  hashtags          String?
  platforms         String[]
  mediaUrls         String[]
  status            String           @default("DRAFT")
  scheduledAt       DateTime?
  postedAt          DateTime?
  latePostId        String?
  errorMessage      String?
  metadata          Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  contentTemplate   ContentTemplate? @relation(fields: [contentTemplateId], references: [id])
  series            PostSeries?      @relation(fields: [seriesId], references: [id])
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  company           Company?          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  analytics         PostAnalytics[]
  schedules         PostSchedule[]

  @@index([companyId])
  @@index([userId, companyId])
  @@index([status, companyId])
}

model PostSchedule {
  id           String    @id @default(cuid())
  userId       String
  companyId    String?
  postId       String?
  title        String
  content      String
  caption      String?
  hashtags     String?
  platforms    String[]
  scheduleType String
  scheduledAt  DateTime
  timezone     String    @default("UTC")
  isRecurring  Boolean   @default(false)
  interval     Int?
  endDate      DateTime?
  status       String    @default("ACTIVE")
  lastRun      DateTime?
  nextRun      DateTime?
  runCount     Int       @default(0)
  maxRuns      Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  post         Post?     @relation(fields: [postId], references: [id])
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  company      Company?   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId, companyId])
  @@index([status, companyId])
}

model PostAnalytics {
  id         String   @id @default(cuid())
  userId     String
  companyId  String?
  postId     String
  platform   String
  views      Int?     @default(0)
  likes      Int?     @default(0)
  shares     Int?     @default(0)
  comments   Int?     @default(0)
  clicks     Int?     @default(0)
  reach      Int?     @default(0)
  engagement Float?   @default(0)
  data       Json?
  fetchedAt  DateTime @default(now())
  createdAt  DateTime @default(now())
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company    Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([postId, platform])
  @@index([companyId])
  @@index([userId, companyId])
}

model GeneratedContent {
  id            String   @id @default(cuid())
  userId        String?
  prompt        String
  generatedText String
  contentType   String
  platform      String?
  topic         String?
  tone          String?
  model         String   @default("gpt-4.1-mini")
  tokensUsed    Int?
  isUsed        Boolean  @default(false)
  createdAt     DateTime @default(now())
}

model PromptFolder {
  id        String        @id @default(cuid())
  userId    String
  companyId String?
  name      String
  color     String?       // Optional color for folder visual distinction
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  company   Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  prompts   SavedPrompt[]

  @@index([companyId])
  @@index([userId, companyId])
}

model SavedPrompt {
  id        String        @id @default(cuid())
  userId    String
  companyId String?
  folderId  String?
  title     String
  prompt    String        @db.Text
  category  String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  company   Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  folder    PromptFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId, companyId])
  @@index([folderId])
}

model Template {
  id              String             @id @default(cuid())
  userId          String
  companyId       String?
  name            String
  description     String?
  category        String
  imageUrl        String
  width           Int                @default(1080)
  height          Int                @default(1080)
  isPublic        Boolean            @default(false)
  canvaTemplateId String?
  usageCount      Int                @default(0)
  shareableLink   String?            @unique
  platforms       String[]           @default([])
  previewData     Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  graphics        GeneratedGraphic[]
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  company         Company?            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  fields          TemplateField[]

  @@index([companyId])
  @@index([userId, companyId])
  @@index([isPublic, companyId])
}

model TemplateField {
  id           String   @id @default(cuid())
  templateId   String
  fieldName    String
  fieldLabel   String
  fieldType    String
  x            Int
  y            Int
  width        Int?
  height       Int?
  fontSize     Int      @default(24)
  fontFamily   String   @default("Arial")
  fontColor    String   @default("#000000")
  fontWeight   String   @default("normal")
  textAlign    String   @default("left")
  defaultValue String?
  isRequired   Boolean  @default(false)
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  opacity      Float    @default(1.0)
  imagePreview String?
  visible      Boolean  @default(true)
  videoPreview String?
  template     Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
}

model GeneratedGraphic {
  id         String   @id @default(cuid())
  userId     String
  companyId  String?
  templateId String
  name       String
  imageUrl   String
  formData   Json
  width      Int
  height     Int
  isUsed     Boolean  @default(false)
  postId     String?
  createdAt  DateTime @default(now())
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company    Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId, companyId])
}

model WorkspaceBranding {
  id          String   @id @default(cuid())
  userId      String
  companyId   String?
  name        String
  logoUrl     String?
  brandColors String[]
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@index([companyId])
  @@index([userId, companyId])
}

model Team {
  id          String       @id @default(cuid())
  userId      String
  companyId   String?
  name        String
  description String?
  order       Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  members     TeamMember[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([userId, companyId])
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  name      String
  handle    String?
  platform  String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

model PostSeries {
  id                  String   @id @default(cuid())
  userId              String
  companyId           String
  profileId           String?  // Optional profile to post as
  name                String
  description         String?
  frequency           String   // "ONCE_WEEK", "TWICE_WEEK", "THREE_WEEK", "CUSTOM"
  daysOfWeek          String[] // ["MONDAY", "WEDNESDAY", "FRIDAY"]
  timeOfDay           String?  // "09:00", "14:30"
  timezone            String   @default("America/New_York") // Timezone for scheduling
  platforms           String[] // Which platforms to post to
  startDate           DateTime
  endDate             DateTime?
  status              String   @default("ACTIVE") // "ACTIVE", "PAUSED", "COMPLETED"
  nextScheduledAt     DateTime?
  autoPost            Boolean  @default(true) // Auto-post to social media
  deleteAfterPosting  Boolean  @default(false) // Delete from cloud storage after posting
  // Cloud storage integration fields (Google Drive or Dropbox)
  googleDriveFolderId String?  // Google Drive folder ID
  dropboxFolderId     String?  // Dropbox folder path (used as ID)
  dropboxFolderPath   String?  // Dropbox folder path (human-readable)
  prompt              String?  // AI prompt for content generation
  currentFileIndex    Int      @default(1) // Current file number to process (1, 2, 3...)
  loopEnabled         Boolean  @default(false) // Loop back to file 1 after reaching the end
  isProcessing        Boolean  @default(false) // Atomic lock to prevent concurrent processing
  lastProcessedAt     DateTime? // Last time a file was processed
  currentLatePostId   String? // Current Late API post ID (for tracking when it gets published)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company             Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  profile             Profile? @relation(fields: [profileId], references: [id], onDelete: SetNull)
  posts               Post[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([userId, companyId])
  @@index([status, nextScheduledAt])
}

model GoogleDriveFolderMapping {
  id                String                 @id @default(cuid())
  userId            String
  companyId         String?
  folderName        String
  folderId          String                 // Google Drive folder ID
  prompt            String                 // AI prompt for processing files from this folder
  platforms         String[]               // Platforms to post to
  profileId         String?                // Optional: specific profile to use
  isActive          Boolean                @default(true)
  autoPost          Boolean                @default(true) // Auto-post or save as draft
  deleteAfterPost   Boolean                @default(false) // Delete file from Drive after posting
  lastChecked       DateTime?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  company           Company?                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  processedFiles    GoogleDriveProcessedFile[]

  @@unique([companyId, folderId])
  @@index([companyId, isActive])
  @@index([userId, companyId])
}

model GoogleDriveProcessedFile {
  id          String                    @id @default(cuid())
  mappingId   String
  fileId      String                    // Google Drive file ID
  fileName    String
  fileType    String                    // image/video
  fileUrl     String?                   // Downloaded file URL
  status      String                    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  postId      String?                   // Created post ID
  generatedContent String?              // AI-generated content
  errorMessage String?
  processedAt DateTime?
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  mapping     GoogleDriveFolderMapping  @relation(fields: [mappingId], references: [id], onDelete: Cascade)

  @@unique([mappingId, fileId])
  @@index([status])
}
